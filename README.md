# README ‚Äî RT WebSocket Boilerplate (FastAPI)

–£—á–µ–±–Ω—ã–π –ø—Ä–æ–µ–∫—Ç/–±–æ–π–ª–µ—Ä–ø–ª–µ–π—Ç –¥–ª—è –∫—É—Ä—Å–∞ **¬´–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç FastAPI Python¬ª**.
–î–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç —Ä–µ–∞–ª-—Ç–∞–π–º –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ WebSocket + Redis Pub/Sub —Å –±–∞–∑–æ–≤–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π –ø–æ JWT, –∫–æ–Ω—Ç—Ä–æ–ª–µ–º Origin –∏ ¬´presence¬ª (–æ–Ω–ª–∞–π–Ω-—Å—Ç–∞—Ç—É—Å).

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

* WebSocket-—ç–Ω–¥–ø–æ–∏–Ω—Ç `/ws/{room}` —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π **Origin** –∏ **JWT** –¥–æ `accept()`.
* –®–∏–Ω–∞ —Å–æ–±—ã—Ç–∏–π —á–µ—Ä–µ–∑ **Redis** (—á–µ—Ä–µ–∑ `broadcaster`): —Å–æ–æ–±—â–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–ª—è—é—Ç—Å—è –≤—Å–µ–º –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–º –∫ –∫–æ–º–Ω–∞—Ç–µ –∫–ª–∏–µ–Ω—Ç–∞–º.
* –õ–æ–∫–∞–ª—å–Ω—ã–π –º–µ–Ω–µ–¥–∂–µ—Ä —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π –∏ –ø—Ä–æ—Ü–µ—Å—Å–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–æ–º–Ω–∞—Ç—ã —Å –∞–≤—Ç–æ-–æ—Ç–ø–∏—Å–∫–æ–π.
* Heartbeat (`system.ping`), `idle timeout` –∏ –ø—Ä–æ—Å—Ç–∞—è —Å—Ö–µ–º–∞ presence (TTL –≤ Redis).
* Pydantic v2, Python 3.11+ (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è `asyncio.TaskGroup`).

## –°—Ç–µ–∫

* FastAPI, Uvicorn
* Redis (Pub/Sub + —Ö—Ä–∞–Ω–µ–Ω–∏–µ presence)
* broadcaster, redis-py (asyncio)
* PyJWT, Pydantic v2

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞

```
app/
  config.py            # –∫–æ–Ω—Ñ–∏–≥, –Ω–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è Origin, –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã
  logger.py            # –±–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–æ–≤
  protocol.py          # –º–æ–¥–µ–ª–∏ –∏ —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π (Pydantic)
  auth.py              # –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è JWT
  state.py             # –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Å–∏–Ω–≥–ª—Ç–æ–Ω—ã (Redis, Broadcast)
  managers.py          # RoomManager ‚Äî –ª–æ–∫–∞–ª—å–Ω—ã–µ WS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
  subscriptions.py     # –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–∞ –∫–∞–Ω–∞–ª—ã Redis –ø–æ –∫–æ–º–Ω–∞—Ç–∞–º
  lifespan.py          # init/cleanup Redis –∏ Broadcast
  websocket_routes.py  # /ws/{room}
  main.py              # FastAPI(app), –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Ä–æ—É—Ç–µ—Ä–∞
```

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

* Python **3.11+**
* –ó–∞–ø—É—â–µ–Ω–Ω—ã–π **Redis**
* (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) `websocat` –∏–ª–∏ `wscat` –¥–ª—è —Ç–µ—Å—Ç–æ–≤ WS

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∏ –∑–∞–ø—É—Å–∫

```bash
python -m venv .venv && source .venv/bin/activate
pip install -U pip

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
cat > requirements.txt <<'REQ'
fastapi>=0.111
uvicorn[standard]>=0.30
pydantic>=2.5
redis>=5.0
broadcaster>=0.3
PyJWT>=2.8
REQ
pip install -r requirements.txt

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è (–ø—Ä–∏–º–µ—Ä)
export REDIS_URL="redis://localhost:6379"
export JWT_SECRET="change-me"
export JWT_ALG="HS256"
export ALLOWED_ORIGINS="http://localhost:8000"  # whitelist –¥–ª—è Origin –∑–∞–≥–æ–ª–æ–≤–∫–∞

# –°—Ç–∞—Ä—Ç
uvicorn app.main:app --reload
```

## –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

* `REDIS_URL` ‚Äî –∞–¥—Ä–µ—Å Redis (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `redis://localhost:6379`)
* `JWT_SECRET`, `JWT_ALG` ‚Äî –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏–∏ JWT (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `change-me`, `HS256`)
* `ALLOWED_ORIGINS` ‚Äî —Å–ø–∏—Å–æ–∫ —Ä–∞–∑—Ä–µ—à—ë–Ω–Ω—ã—Ö Origin (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é), —Ñ–æ—Ä–º–∞—Ç `scheme://host[:port]`
* `PRESENCE_TTL` ‚Äî TTL –∫–ª—é—á–∞ –ø—Ä–∏—Å—É—Ç—Å—Ç–≤–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `60`)
* `HEARTBEAT_INTERVAL` ‚Äî –ø–µ—Ä–∏–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ `system.ping` (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `25`)
* `IDLE_TIMEOUT` ‚Äî –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –±–µ–∑–¥–µ–π—Å—Ç–≤—É—é—â–∏—Ö —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é `70`)

## –ë—ã—Å—Ç—Ä—ã–π —Å–º–æ—É–∫-—Ç–µ—Å—Ç WebSocket

1. –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–∫–µ–Ω:

```bash
python - <<'PY'
import jwt, time
print(jwt.encode({"sub":"u1","iat":int(time.time())}, "change-me", algorithm="HS256"))
PY
```

2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –∫–æ–º–Ω–∞—Ç–µ `test` (–ø—Ä–∏–º–µ—Ä —Å websocat):

```bash
TOKEN=... # –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω
websocat -H=Origin:http://localhost:8000 "ws://127.0.0.1:8000/ws/test?token=$TOKEN"
```

3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ:

```json
{"type":"chat.message","room":"test","text":"hi"}
```

–û–∂–∏–¥–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç-–¥–æ—Å—Ç–∞–≤–∫–∞:

```json
{"type":"chat.delivery","room":"test","user":"u1","text":"hi","id":"...","ts":...}
```

–ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ –±—É–¥–µ—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å `{"type":"system.ping", ...}`.

## –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

* –ö–æ–¥ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω –¥–ª—è –æ–±—É—á–µ–Ω–∏—è: –Ω–µ –ø—Ä–µ—Ç–µ–Ω–¥—É–µ—Ç –Ω–∞ –ø–æ–ª–Ω–æ—Ç—É –ø—Ä–æ–¥-—Ä–µ—à–µ–Ω–∏—è, –Ω–æ –∑–∞–¥–∞—ë—Ç –∑–¥—Ä–∞–≤—ã–π –∫–∞—Ä–∫–∞—Å.
* –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ –¥–æ–±–∞–≤—å—Ç–µ: –º–µ—Ç—Ä–∏–∫–∏/—Ç—Ä–µ–π—Å–∏–Ω–≥, rate-limit/–∫—É—á–µ–≤—ã–µ –∑–∞—â–∏—Ç—ã, –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω—ã–π —Å—Ç–æ—Ä –¥–ª—è –∏—Å—Ç–æ—Ä–∏–∏, —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ –∏ —Ä–µ—Ç—Ä–∞–∏ –≤–Ω–µ—à–Ω–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π.

–õ–∏—Ü–µ–Ω–∑–∏—Ä—É–π—Ç–µ –∏ –º–æ–¥–∏—Ñ–∏—Ü–∏—Ä—É–π—Ç–µ –ø–æ —Å–≤–æ–µ–º—É —É—Å–º–æ—Ç—Ä–µ–Ω–∏—é. –£–¥–∞—á–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏! üöÄ
